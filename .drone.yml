---
kind: pipeline
name: python-template

steps:
  - name: lint python files
    image: udcservice/python:latest
    commands:
      - make init
      - make lint

  - name: test python functions
    image: udcservice/python:latest
    commands:
      - make init
      - make test

  - name: create ECR Repo
    image: hashicorp/terraform:latest
    commands:
      - cd ./terraform
      - terraform init
      - terraform plan
      - terraform apply -auto-approve

  - name: publish Docker image
    image: plugins/ecr
    settings:
      repo: udc/python-template
      registry: 613868415919.dkr.ecr.us-east-1.amazonaws.com
      region: us-east-2
      tags:
        - 1.0
    when:
      branch:
      - master

  - name: publish version.json to S3
    image: udcservice/python:latest
    commands:
      - aws s3 cp version.json s3://udc-component-version/python-template.json
